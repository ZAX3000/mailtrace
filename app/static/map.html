<!doctype html>
<html>
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Map • MailTrace</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0}
.toolbar{padding:10px;border-bottom:1px solid #e5e7eb;display:flex;gap:14px;align-items:center}
label{font-weight:600}
#map{height: calc(100vh - 56px);}
</style>
<style>
/* --- MailTrace Navbar (light) --- */
.mt-nav { position: sticky; top: 0; z-index: 40; background: #fff; border-bottom: 1px solid #ececec; }
.mt-nav .wrap { max-width: 1200px; margin: 0 auto; padding: 10px 16px;
  display: flex; align-items: center; justify-content: space-between; gap: 12px; }
.mt-nav .left { display: flex; align-items: center; gap: 12px; }
.mt-nav .right { display: flex; align-items: center; gap: 18px; }
.mt-nav a { text-decoration: none; color: #111; font-weight: 500; font-size: 14px; }
.mt-nav a.active { color: #0a66ff; }
.mt-nav .logo { display:flex; align-items:center; gap:10px; }
.mt-nav .logo img { height: 56px !important; max-height: 56px !important; width: auto; }
.mt-nav .hist { position: relative; }
.mt-nav .hist-btn { cursor: pointer; }
.mt-nav .hist-panel { position: absolute; right: 0; top: 28px; width: 320px; max-height: 360px; overflow:auto;
  background:#fff; border:1px solid #e5e5e5; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.08); padding:8px; display:none; }
.mt-nav .hist.open .hist-panel { display:block; }
.mt-nav .hist-item { padding:8px 10px; border-radius:6px; display:flex; justify-content:space-between; gap:10px; font-size:13px; }
.mt-nav .hist-item:hover { background:#f6f7f9; }
.mt-nav .hist-empty { padding:10px; color:#777; font-size:13px; }
</style>
<style>
.mt-nav .logo img { height: 64px !important; max-height: 64px !important; width: auto; }
.mt-nav .wrap { padding: 6px 16px !important; }
</style>
</head>
<body>
<nav class="mt-nav">
  <div class="wrap">
    <div class="left logo">
      <a href="/dashboard">
        <img src="/static/img/logo.png" alt="MailTrace logo" />
      </a>
    </div>
    <div class="right">
      <a href="/dashboard" id="mt-link-dash">Dashboard</a>
      <a href="/static/map.html" id="mt-link-map">Map</a>
      <div class="hist" id="mt-hist">
        <a class="hist-btn">History ▾</a>
        <div class="hist-panel">
          <div class="hist-empty" id="mt-hist-empty">Loading…</div>
          <div id="mt-hist-list"></div>
        </div>
      </div>
    </div>
  </div>
</nav>

<div class="toolbar">
  <label><input type="checkbox" class="k" value="match" checked> Matches</label>
  <label><input type="checkbox" class="k" value="mail"> Mail addresses</label>
  <label><input type="checkbox" class="k" value="crm"> CRM addresses</label>
  <span style="margin-left:20px">From <input type="date" id="from"> To <input type="date" id="to"></span>
  <button id="apply">Apply</button>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/overlapping-marker-spiderfier-leaflet/oms.min.js"></script>
<script>
const map = L.map('map').setView([37.8,-96], 4);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19, attribution: '&copy; OpenStreetMap'}).addTo(map);

let cluster = L.markerClusterGroup();
map.addLayer(cluster);
let oms = new OverlappingMarkerSpiderfier(map);

function fetchData() {
  const kinds = Array.from(document.querySelectorAll('.k:checked')).map(x=>x.value);
  const params = new URLSearchParams();
  kinds.forEach(k=>params.append('kind', k));
  const d0 = document.getElementById('from').value;
  const d1 = document.getElementById('to').value;
  if (d0) params.append('from', d0);
  if (d1) params.append('to', d1);
  fetch('/map/data?'+params.toString()).then(r=>r.json()).then(draw);
}

function draw(points) {
  cluster.clearLayers();
  points.forEach(p => {
    if (!p.lat || !p.lon) return;
    const m = L.marker([p.lat, p.lon]);
    m.bindPopup(`<b>${p.kind.toUpperCase()}</b><br>${p.address}<br>${p.date || ''}`);
    cluster.addLayer(m);
    oms.addMarker(m);
  });
}

document.getElementById('apply').addEventListener('click', fetchData);
fetchData();
</script>

<script>
(function(){
  const p = location.pathname.replace(/\/$/, '');
  if (p === '' || p === '/dashboard') document.getElementById('mt-link-dash')?.classList.add('active');
  if (p === '/map' || p.endsWith('/static/map.html')) document.getElementById('mt-link-map')?.classList.add('active');

  const hist = document.getElementById('mt-hist');
  if (!hist) return;
  const btn = hist.querySelector('.hist-btn');
  const list = document.getElementById('mt-hist-list');
  const empty = document.getElementById('mt-hist-empty');

  btn.addEventListener('click', () => hist.classList.toggle('open'));
  document.addEventListener('click', (e) => { if (!hist.contains(e.target)) hist.classList.remove('open'); });

  fetch('/api/runs')
    .then(r=>r.json()).then(data => {
      const runs = (data && data.runs) || [];
      empty.style.display = runs.length ? 'none' : 'block';
      list.innerHTML = runs.map((r,i) => {
        const dt = r.started_at ? new Date(r.started_at) : null;
        const label = dt ? dt.toLocaleString() : ('Run ' + (i+1));
        return `<a class="hist-item" href="/dashboard?run_id=${encodeURIComponent(r.run_id)}">
                  <span>${label}</span>
                  <span style="color:#999">${r.mail_count||0} mail</span>
                </a>`;
      }).join('');
    })
    .catch(()=>{ empty.textContent = 'No runs found'; });
})();
</script>


<script>
document.addEventListener('DOMContentLoaded', function() {
  const nodes = document.querySelectorAll('h1,h2,h3,div,section,header');
  for (const n of nodes) {
    const t = (n.textContent || '').toLowerCase();
    if (t.includes('modular dashboard')) { n.remove(); break; }
  }
});
</script>

</body>
</html>
