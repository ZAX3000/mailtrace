<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MailTrace Map</title>

  <style>
    html,
    body,
    #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    .pill {
      position: fixed;
      top: 10px;
      left: 10px;
      background: #111;
      color: #fff;
      padding: 6px 10px;
      border-radius: 999px;
      font: 14px/1.2 system-ui;
    }
  </style>

  {# Only include Mapbox assets when we intend to use them #}
  {% if use_mapbox %}
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.css" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.js" defer></script>
  {% endif %}

  <!-- Always include Leaflet (fallback or primary if no Mapbox token) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

  <!-- Prettier-friendly config handoff (no JS braces inside Jinja) -->
  <script id="map-config" type="application/json">
      {{ {"use_mapbox": use_mapbox, "mapbox_token": mapbox_token}|tojson }}
    </script>
</head>

<body>
  <div id="map"></div>
  <div class="pill" id="map-pill"></div>

  <script>
    // tiny “wait until global exists” helper for deferred CDN scripts
    const waitFor = (testFn, timeout = 4000, step = 50) =>
      new Promise((resolve, reject) => {
        const t0 = performance.now();
        (function tick() {
          if (testFn()) return resolve();
          if (performance.now() - t0 > timeout)
            return reject(new Error("timeout"));
          setTimeout(tick, step);
        })();
      });

    (async () => {
      // read config produced by Jinja with zero brace juggling
      const cfgEl = document.getElementById("map-config");
      const cfg = JSON.parse(cfgEl.textContent || "{}");
      const useMapbox = !!cfg.use_mapbox && !!cfg.mapbox_token;
      const pill = document.getElementById("map-pill");
      pill.textContent = useMapbox ? "Mapbox" : "Leaflet + OpenStreetMap";

      // load feature data
      const res = await fetch("{{ url_for('map.data') }}");
      const fc =
        (await res
          .json()
          .catch(() => ({ type: "FeatureCollection", features: [] }))) || {};
      const features = Array.isArray(fc.features) ? fc.features : [];

      if (useMapbox) {
        // Mapbox branch
        await waitFor(() => window.mapboxgl);
        mapboxgl.accessToken = cfg.mapbox_token;

        const map = new mapboxgl.Map({
          container: "map",
          style: "mapbox://styles/mapbox/streets-v11",
          center: [-96.8, 37.8],
          zoom: 3.5,
        });

        map.on("load", () => {
          map.addSource("points", { type: "geojson", data: fc });
          map.addLayer({
            id: "pt",
            type: "circle",
            source: "points",
            paint: {
              "circle-radius": 4,
              "circle-color": "#0ea5e9",
              "circle-stroke-width": 1,
              "circle-stroke-color": "#0b4a6f",
            },
          });

          if (features.length) {
            const b = new mapboxgl.LngLatBounds();
            for (const f of features) {
              const c = f?.geometry?.coordinates;
              if (Array.isArray(c)) b.extend(c);
            }
            if (!b.isEmpty()) map.fitBounds(b, { padding: 40, duration: 0 });
          }
        });
        return;
      }

      // Leaflet branch
      await waitFor(() => window.L);
      const map = L.map("map");
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap",
      }).addTo(map);

      const pts = [];
      for (const f of features) {
        const coords = f?.geometry?.coordinates;
        if (!Array.isArray(coords)) continue;
        const [lon, lat] = coords;
        pts.push([lat, lon]);
        L.circleMarker([lat, lon], { radius: 5 })
          .addTo(map)
          .bindPopup(
            `${f?.properties?.label || ""}<br>${f?.properties?.address || ""}`
          );
      }
      if (pts.length) {
        map.fitBounds(L.latLngBounds(pts).pad(0.2));
      } else {
        map.setView([37.8, -96.8], 4);
      }
    })().catch((e) => {
      console.error("map init error", e);
    });
  </script>
</body>

</html>